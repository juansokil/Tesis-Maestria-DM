---
title: "Infografia"
output:
  flexdashboard::flex_dashboard: default
  #orientation: rows
  orientation: columns
  horizontal_layout: scroll
  html_document: default
runtime: shiny

---



```{r}
library(readr)
library(dplyr)
library(leaflet)
library(DT)
library(shiny)
library(htmlwidgets)
library(rnaturalearth)
library(ggplot2)
library(shinyWidgets)
library(knitr)
library(kableExtra)
library(formattable)



#####LEVANTA DATOS################

#indice_especializacion <- read_delim("C:/Users/Juan/Desktop/Materiales TESIS PARA APLICACION/indice_especializacion.csv", "\t", escape_double = FALSE, locale = locale(encoding = "ASCII"),  trim_ws = TRUE)

indice_especializacion <- read_delim("./indice_especializacion.csv", ";", escape_double = FALSE, locale = locale(encoding = "latin1"),  trim_ws = TRUE)

indice_especializacion$participacion <- indice_especializacion$participacion*100

indice_especializacion_tematica <- read_delim("./indice_especializacion_tematica.csv", 
    ";", escape_double = FALSE, locale = locale(encoding = "latin1"), trim_ws = TRUE)


listado_paises <- indice_especializacion %>% filter(!is.na(participacion)) %>% select(pais) %>% unique() %>% arrange(pais)
listado_paises2 <- indice_especializacion_tematica %>%  select(pais) %>% unique() %>% arrange(pais)
listado_paises3 <- indice_especializacion_tematica %>%  select(pais) %>% unique() %>% arrange(pais)


```

Resumen
=====================================  

La siguiente aplicación presenta los indicadores construidos durante la tesis.    
El objetivo de la tesis es estudiar la producción científica mundial sobre estudios de género en el periodo 2003-2018.   
  



* Indice de Especialización: Participacion de los estudios de genero dentro del total de la produccion científica del pais.
  + Desagregado a nivel periodo y a nivel pais

* Indice de Especializacion Tematica: Construido a partir de la aplicacion de LDA al corpus 
  + Desagregado a nivel topico, periodo y pais.



Los datos completos pueden descargarse en el siguiente [link](https://github.com/juansokil) 


Especializacion
=====================================  



Inputs {.sidebar}
-------------------------------------



```{r}
selectizeInput('periodo', label = "Seleccione el periodo",  
              choices = c("2004_2006","2007_2009","2010_2012",'2013_2015','2016_2018'),  
              selected = c("2016_2018"), multiple = FALSE)
```

Indice de Especialización en genero a nivel pais y periodo.   

Seleccionando un periodo se actualiza el mapa y la tabla.

Columns
-------------------------------------

### Indice de Especialización en genero por pais y periodo {data-height=200}


```{r, fig.height=4}


mapa_reactivo <- reactive({
map <- ne_countries()
names(map)[names(map) == "iso_a2"] <- "ISO2"
var_particip <- indice_especializacion %>%
  mutate(pais2=pais)  %>%
filter(periodo == input$periodo & !is.na(participacion) & !is.na(ISO2)) %>%
  select(pais, ISO2,periodo, value=participacion, pais2)    %>%
  arrange(desc(value))  %>% tibble::column_to_rownames('pais')

map$participacion  <- var_particip[match(map$ISO2, var_particip$ISO2), "value"]
map$pais  <- var_particip[match(map$ISO2, var_particip$ISO2), "pais2"]

map$labels <- paste(map$pais, ": ", map$participacion)
map <- subset(map, !is.na(participacion))

mapa_reactivo <- map

}) # END OF REACTIVE



renderLeaflet({
  
pal <- colorBin(
  palette = "viridis", domain = mapa_reactivo()$participacion, na.color = "transparent",
  bins = seq(0, 5, by = 0.5)
)


leaflet(mapa_reactivo()) %>% 
  addTiles()  %>%
  addPolygons( 
    fillColor = ~ pal(participacion), label = ~labels,
    stroke=FALSE, 
    fillOpacity = 0.9, 
    color="white", 
    weight=0.3
    ) 
})



```   
 
Columns
-------------------------------------

### Indice de Especialización en genero por pais y periodo {data-height=100}


indice_especializacion


```{r, fig.height=4}



datos_tabla <- reactive({
  indice_especializacion %>% 
      filter(periodo %in% input$periodo) %>% 
      select(ISO2, pais, continente, participacion) %>% mutate(participacion=round(participacion, 2)) 
})



renderDT(
as.datatable(
formattable(datos_tabla() %>% select(-ISO2) %>% filter(!is.na(participacion)) %>% arrange(desc(participacion)), align = c("c","c","l"),
            list(
            participacion = color_bar("#DeF7E9"),
            pais = formatter("span", style = ~ style(color = ifelse(continente == 'Europa', "cornflowerblue", 
                                                                    ifelse(continente == 'Asia', "#e8b000", ifelse(continente == 'Africa', "grey", ifelse(continente == 'America', "red",  ifelse(continente == 'Oceania', "forestgreen", "black"))))
            ))),
            continente = formatter("span", style = ~ style(color = ifelse(continente == 'Europa', "cornflowerblue", 
                                                                    ifelse(continente == 'Asia', "#e8b000", ifelse(continente == 'Africa', "grey", ifelse(continente == 'America', "red",  ifelse(continente == 'Oceania', "forestgreen", "black"))))
            )))
            ))))



```  
  



Especializacion - Evolucion Temporal
=====================================  


Inputs {.sidebar}
-------------------------------------

```{r}
selectizeInput('paises', label = "Seleccione paises a comparar", choices = listado_paises, selected = c("Argentina","Islandia"), multiple = TRUE)
```


Indice de Especialización Comparativo.   

En este segmento se pueden seleccionar distintos paises y comparar la evolución de su especialización en genero.  

Al agregar o quitar un pais se actualiza el gráfico y la tabla.


Columns 
-------------------------------------


### Indice de Especialización Evolucion por pais  {data-height=200}



```{r, fig.height=4}


datos_evolucion <- reactive({
  indice_especializacion %>% 
      filter(pais %in% input$paises) %>% 
      select(ISO2, pais, continente, periodo, participacion) %>% mutate(participacion=round(participacion, 2))
})


datos_evolucion_mundial <- reactive({
  indice_especializacion %>% 
      filter(pais %in% 'Mundial') %>% 
      select(ISO2, pais, continente, periodo, participacion) %>% mutate(participacion=round(participacion, 2))
})

renderPlot({

ggplot(datos_evolucion(), aes(periodo, participacion, group=pais, color=pais)) + geom_line() + geom_point()  +
    geom_line(data=datos_evolucion_mundial(), aes(group=pais, color=pais), color='black', linetype = "solid") +    
    geom_point(data=datos_evolucion_mundial(), aes(group=pais, color=pais), color='black') +
  ylim(0, 5) + theme(legend.position="bottom", legend.title= element_blank())   + labs(caption="La linea negra representa el valor mundial")
})
  



```   

Columns 
-------------------------------------

### Indice de Especialización Evolucion por pais {data-height=100}


```{r, fig.height=4}




renderDT(
as.datatable(formattable(datos_evolucion() %>% select(-ISO2) %>% filter(!is.na(participacion)) %>% arrange(desc(participacion)), align = c("c","c","r"),
            list(
            participacion = color_bar("#DeF7E9"),
            pais = formatter("span", style = ~ style(color = ifelse(continente == 'Europa', "cornflowerblue", 
                                                                    ifelse(continente == 'Asia', "#e8b000", ifelse(continente == 'Africa', "grey", ifelse(continente == 'America', "red",  ifelse(continente == 'Oceania', "forestgreen", "black"))))
            ))),
            continente = formatter("span", style = ~ style(color = ifelse(continente == 'Europa', "cornflowerblue", 
                                                                    ifelse(continente == 'Asia', "#e8b000", ifelse(continente == 'Africa', "grey", ifelse(continente == 'America', "red",  ifelse(continente == 'Oceania', "forestgreen", "black"))))
            )))
            ))))





```  
  


 
 
Especializacion Tematica
=====================================  

Inputs {.sidebar}
-------------------------------------

```{r}

selectizeInput('periodo2', label = "Seleccione el periodo",  
              choices = c("2004_2006","2007_2009","2010_2012",'2013_2015','2016_2018'),  
              selected = c("2016_2018"), multiple = FALSE)


selectizeInput('paises2', label = "Seleccione paises a comparar", choices = listado_paises2, selected = c("Argentina","Islandia"), multiple = TRUE)

```



Rows
-------------------------------------

```{r, fig.height=5}




base2 <- reactive({
indice_especializacion_tematica %>% filter(pais %in% input$paises2 & periodo %in% (input$periodo2))
})


mundial2 <- reactive({
  indice_especializacion_tematica %>% filter(pais == "Mundial" & periodo %in% input$periodo2)
})

```   
 

### Especializacion    {data-height=100}

```{r, fig.height=4}


renderPlot({


ggplot(base2(), aes(topico, importancia_topico, group=pais,  fill=pais)) +
    geom_col(stat="identity", position="dodge") +
    geom_point(data=mundial2(), aes(topico, importancia_topico, group=pais, fill=pais, size=12), color='black') +
  ylim(0, 0.3) +scale_size(guide=FALSE) +
   theme(legend.position="bottom", legend.title= element_blank(), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))  + labs(caption="Los puntos negros representan el valor mundial de cada tópico")
  
})
  
```   
 
 

 
Especializacion Tematica - Evolucion
=====================================  

Inputs {.sidebar}
-------------------------------------

```{r}

selectizeInput('paises3', label = "Seleccione paises a comparar", choices = listado_paises3, selected = c("Argentina","Islandia"), multiple = TRUE)

selectizeInput('topicos', label = "Seleccione Topico", choices = indice_especializacion_tematica %>% select(topico) %>% unique(), selected = c("T96 - Teoría feminista","T21 - Identidades de genero"), multiple = FALSE) 

```




Columns 
-------------------------------------


```{r, fig.height=5}


base3 <- reactive({
indice_especializacion_tematica %>% filter(pais %in% input$paises3 & topico %in% input$topicos) %>% mutate(importancia_topico=round(importancia_topico, 4))
})


mundial3 <- reactive({
  indice_especializacion_tematica %>% filter(pais == "Mundial" & topico %in% input$topicos)
})

```   
 

 
### Especializacion por topico {data-height=200}

```{r, fig.height=4}

renderPlot({
ggplot(base3(), aes(periodo, importancia_topico, group=pais, color=pais)) + geom_line() + geom_point() +
    geom_line(data=mundial3(), aes(group=pais, color=pais), color='black', linetype = "solid")  + geom_point() +
  ylim(0, 0.23) + geom_point(data=mundial3(), aes(group=pais, color=pais), color='black') +
   theme(legend.position="bottom", legend.title= element_blank())  + labs(caption="La linea negra representa el valor mundial")

})
  
```  





Columns 
-------------------------------------
### Especializacion por topico {data-height=100}


```{r, fig.height=4}


renderDT(
as.datatable(formattable(base3() %>% select(periodo, topico, pais, continente, importancia_topico) %>% filter(!is.na(importancia_topico)) %>% arrange(desc(importancia_topico)), align = c("c","c","r"),
            list(
            importancia_topico = color_bar("#DeF7E9"),
            pais = formatter("span", style = ~ style(color = ifelse(continente == 'Europa', "cornflowerblue", 
                                                                    ifelse(continente == 'Asia', "#e8b000", ifelse(continente == 'Africa', "grey", ifelse(continente == 'America', "red",  ifelse(continente == 'Oceania', "forestgreen", "black"))))
            ))),
            continente = formatter("span", style = ~ style(color = ifelse(continente == 'Europa', "cornflowerblue", 
                                                                    ifelse(continente == 'Asia', "#e8b000", ifelse(continente == 'Africa', "grey", ifelse(continente == 'America', "red",  ifelse(continente == 'Oceania', "forestgreen", "black"))))
            )))
            ))))





```  
  
#Faltaria una solapa mas (en el 4to lugar que permita elegir un topico - periodo y ver todos los paises) y entonces la solapa 2 y la 5 son comparadors

